<section>
<p>So in my <a href="/#log/2010/03/07/On_Reinventing_the_Wheel">last entry</a>, 
   I hinted at some projects I had been mulling over. One of those ideas was 
   DS.NET, a port of the <a href="http://www.netmf.com/home.aspx" target="_blank" rel="external">.NET Micro Framework (NETMF)</a>
   to the <a href="http://en.wikipedia.org/wiki/Nintendo_DS" rel="external" rel="external">Nintendo DS (NDS)</a>
   hardware platform. The NDS is a nifty little piece of hardware with two 
   processors (ARM7, ARM9), two LCD screens (one with touch input), sound
   I/O and 802.11b Wireless Ethernet. The real reason NETMF should be ported
   to the NDS is that in doing so, the ability for homebrew application 
   development would become easier for those interested in programming for the
   NDS. No fiddling around with different graphics modes and control registers,
   just pure managed C#.</p>
<p>So, in this article I'll briefly explain what NETMF is, what I think is 
   required to port the NETMF platform to the NDS, and the next steps in the
   DS.NET project. Now I wont make any promises that there will be a port of
   the framework, but hey, it's not like I wont give it a go!</p>
</section>
<section>
    <header>.NET Micro Framework: Smart Programming of Dumb Devices</header>
    <p>In a nutshell, NETMF is a significantly pared-down version of the .NET
       <abbr title="Base Class Library">BCL</abbr> running on an <abbr title="Common Intermediate Language">CIL</abbr>
       interpreter geared towards embedded devices ("bare metal"). The framework
       can be booted from flash memory and allows applications running in the
       interpreter to access the underlying hardware through managed drivers.
       Figure 1 below illustrates the layered levels of the framework:</p>
    <figure>
        <img src="/img/netmf.jpg" alt="Layout of the NETMF software stack" />
        <figcaption><strong>Figure 1</strong> .NET Micro Framework Architecture Layers &dagger;</figcaption>
    </figure>
    <p>So the topmost layer is, as with NETMF's bigger brothers the Compact 
       Framework and the Full framework. the application layer where managed
       user code executes. To develop applications for NETMF devices requires
       the NETMF SDK. Directly underneath is the library-level layer, where
       the .NET Base Class Library (BCL), Windows Presentation Foundation 
       (WPF) and harware-specific libraries are. In the runtime component
       layer lies the Common Language Runtime (CLR), the Platform Abstraction
       Layer (PAL), and the Hardware Abstraction Layer (HAL). It could probably
       be said that each of these three components are separate layers 
       themselves, but hey, whatever floats MS's boat right?</p>
</section>
<section>
    <header>Nintendo DS: A Hacker's Paradox</header>
    <p>Homebrew software development for the NDS has been around for a long 
       time, with hundreds of hackers reverse-engineering the hidden 
       proprietary magic inside. So, what has the NDS got to offer the 
       DS.NET developer?</p>
    <dl>
        <dt>Processing</dt>
        <dd>An <a href="http://www.arm.com/products/processors/classic/arm9/arm946.php" target="_blank">ARM946E-S</a> processor running at 67Mhz, typically used to handle application execution (including graphical routines)</dd>
        <dd>An <a href="http://www.arm.com/products/processors/classic/arm7/arm7tdmi.php" target="_blank">ARM7TDMI</a> processor running at 33Mhz, typically used to handle on-board device management</dd>
        <dd>Multiple graphics interfaces, including a 3D renderer and two 2D renderers</dd>
    </dl>
    <dl>
        <dt>Memory</dt>
        <dd>4MB of <abbr title="External Working RAM">EWRAM</abbr> shared between both cores</dd>
	    <dd>16kB of <abbr title="Instruction Tightly-Coupled Memory">ITCM</abbr> used to store frequently-used routines and accessable only to the ARM9 core</dd>
	    <dd>16kB of <abbr title="Data Tightly-Coupled Memory">DTCM</abbr> used to store frequently-used variables and acessable only to the ARM9 core</dd>
	    <dd>64kB of <abbr title="Internal Working RAM">IWRAM</abbr> fast memory than is accessable only by the ARM7 core</dd>
	    <dd>2&times;16kB banks of <abbr title="Working RAM">WRAM</abbr> which can mapped to the memory space of either core</dd>
	    <dd>656kB <abbr title="Video RAM">VRAM</abbr> split into multiple banks for varying purposes</dd>
    </dl>
    <dl>
        <dt><abbr title="Input / Output">I/O</abbr></dt>
        <dd>Sound</dd>
        <dd>Microphone</dd>
        <dd>RTC</dd>
        <dd>802.11b Wireless Ethernet</dd>
    </dl>
    <p>All this memory can be confusing! Thankfully, the folks over at Dev-Scene.com
       have <a href="http://www.dev-scene.com/NDS/Tutorials_Day_2#Memory_Layout" target="_blank" rel="external">illustrated the memory configuration of the NDS</a>. Basically, the ITCM and DTCM memories act as an L2 cache for the ARM9 processor, with the IWRAM acting as a shared Instruction/Data cache for the ARM7 processor.</p>
</section>
<section>
    <header>DS.NET: A Worthy Challenge, a whole lotta work!</header>
    <p>So, there are a number of considerations even thinking about porting
       NETMF to the DS. Firstly, we are dealing with a multiprocessor system:
       this means division of labor and synchronization. So knowing that the
       ARM7 processor has exclusive access to the I/O devices of the system,
       let's assign the ARM7 it's own BSP and make it responsible to the ARM9
       processor as a slave. Operating as a slave, we'll make the ARM9 
       processor the master which will run all applications and will have its
       own BSP. Secondly, the toolchain is going to be annoying. A whole bunch
       of code will be required from DevKitPro/ndslib/ndswifi/ndsfat.</p>
</section>
<footer>
    <p>&dagger; <small>Extracted from the .NET Micro Framework Porting Kit CHM Documentation</small></p>
</footer>